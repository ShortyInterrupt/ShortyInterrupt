name: Build & Release (tagged)

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate required addon files exist
        run: |
          set -e
          test -f "ShortyInterrupt/ShortyInterrupt.toc" || (echo "ERROR: ShortyInterrupt/ShortyInterrupt.toc not found" && exit 1)
          test -f "ShortyInterrupt/ShortyInterrupt.lua" || (echo "ERROR: ShortyInterrupt/ShortyInterrupt.lua not found" && exit 1)

          # Optional assets: include if you actually ship them
          if [ -d "ShortyInterrupt/Media" ]; then
            echo "Found ShortyInterrupt/Media/"
          fi

          # If you have a .blp icon and want it in the zip, enforce it here:
          # test -f "ShortyInterrupt/ShortyInterrupt.blp" || (echo "ERROR: ShortyInterrupt/ShortyInterrupt.blp not found" && exit 1)

      - name: Set TOC version from tag
        run: |
          set -e
          VER="${GITHUB_REF_NAME#v}"   # v0.1.6 -> 0.1.6
          echo "VER=${VER}" >> $GITHUB_ENV

          TOC="ShortyInterrupt/ShortyInterrupt.toc"
          if grep -qE '^## Version:' "$TOC"; then
            sed -i "s/^## Version:.*/## Version: ${VER}/" "$TOC"
          else
            echo "## Version: ${VER}" >> "$TOC"
          fi

          echo "TOC version now:"
          grep -E '^## Version:' "$TOC" || true

      - name: Stage addon payload (force ShortyInterrupt folder; exclude repo/dev files)
        run: |
          set -e
          rm -rf _stage
          mkdir -p _stage/ShortyInterrupt

          # Copy ONLY what should ship (entire addon folder)
          cp -a ShortyInterrupt/* _stage/ShortyInterrupt/

          # Optional: strip OS junk if it exists
          find _stage -name ".DS_Store" -delete || true
          find _stage -name "Thumbs.db" -delete || true

          echo "Staged contents:"
          ls -lah _stage/ShortyInterrupt

      - name: Create zip (versioned filename for WowUp display)
        run: |
          set -e
          ZIP_NAME="ShortyInterrupt-${VER}.zip"
          echo "ZIP_NAME=${ZIP_NAME}" >> $GITHUB_ENV

          rm -f "${ZIP_NAME}"
          (cd _stage && zip -r "../${ZIP_NAME}" ShortyInterrupt)

          echo "Zip listing:"
          unzip -l "${ZIP_NAME}" | head -n 120

      - name: Create GitHub Release and upload zip
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.ZIP_NAME }}
          generate_release_notes: true
          body: |
            Guild release build.
            Not intended for general public use. No external support.